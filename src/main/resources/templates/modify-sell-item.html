<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/head :: uikit-head('Modifier l‚Äôench√®re')}"></th:block>
    <link rel="stylesheet" th:href="@{/vendor/eni-enchere/css/sell-item.css}">
</head>
<body>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>
<input type="hidden" th:value="${item.itemId}" />


<div class="uk-section uk-section-muted uk-padding-remove-top">
    <div class="uk-container uk-margin-large-top">
        <div class="uk-card uk-card-default uk-card-body uk-card-hover uk-width-2xlarge uk-margin-auto uk-box-shadow-xlarge uk-border-rounded uk-animation-slide-bottom-small">
            <h2 class="uk-heading-line uk-text-center"><span>‚úèÔ∏è Modifier une ench√®re</span></h2>

            <form class="uk-form-stacked"
                  th:action="@{'/api/updateItem/' + ${item.itemId}}"
                  th:object="${item}"
                  method="post"
                  enctype="multipart/form-data">

                <!-- Nom de l'article -->
                <div class="uk-margin">
                    <label class="uk-form-label" for="article">Nom de l'article</label>
                    <div class="uk-inline uk-width-1-1">
                        <span class="uk-form-icon" uk-icon="icon: tag"></span>
                        <input class="uk-input" type="text" id="article" th:field="*{item.itemName}" placeholder="Ex : Ordinateur portable" required>
                    </div>
                </div>

                <!-- Cat√©gorie -->
                <div class="uk-margin">
                    <label class="uk-form-label" for="category">Cat√©gorie</label>
                    <div class="uk-form-controls">
                        <select class="uk-select" id="category" th:field="*{item.category}" required>
                            <option value="" disabled>-- S√©lectionner une cat√©gorie --</option>
                            <option value="1">Informatique</option>
                            <option value="2">Mobilier</option>
                            <option value="3">Loisir</option>
                        </select>
                    </div>
                </div>

                <!-- Description -->
                <div class="uk-margin">
                    <label class="uk-form-label" for="description">Description</label>
                    <textarea class="uk-textarea" rows="4" id="description" th:field="*{item.description}" placeholder="D√©crivez votre article..." required></textarea>
                </div>

                <!-- Image avec preview -->
                <div class="uk-margin">
                    <label class="uk-form-label" for="photo">Photo de l'article</label>
                    <div uk-form-custom="target: true">
                        <input type="file" id="photo" name="photo" accept="image/*" onchange="previewImage(event)">
                        <input class="uk-input uk-width-1-1" type="text" placeholder="Choisir une image" disabled>
                    </div>
                    <div class="uk-margin-small-top uk-text-center">
                        <img id="imagePreview"
                             th:if="*{photoUrl != null}"
                             th:src="@{${item.photoUrl}}"
                             alt="Aper√ßu de l'image"
                             style="max-width: 300px;"
                             class="uk-border-rounded uk-box-shadow-medium uk-animation-fade">
                    </div>
                </div>

                <!-- Prix et dates -->
                <hr class="uk-divider-icon">
                <div class="uk-grid uk-child-width-1-3@m uk-grid-small" uk-grid>
                    <div>
                        <label class="uk-form-label" for="prix">Prix initial (‚Ç¨)</label>
                        <input class="uk-input" type="number" id="prix" th:field="*{item.startingPrice}" min="1" required>
                    </div>
                    <div>
                        <label class="uk-form-label" for="debut">D√©but de l'ench√®re</label>
                        <input class="uk-input" type="date" id="debut" th:field="*{item.startDate}" required>
                    </div>
                    <div>
                        <label class="uk-form-label" for="fin">Fin de l'ench√®re</label>
                        <input class="uk-input" type="date" id="fin" th:field="*{item.endDate}" required>
                    </div>
                </div>

                <!-- Adresse de retrait -->
                <hr class="uk-divider-icon">
                <fieldset class="uk-fieldset">
                    <legend class="uk-legend">üìç Adresse de retrait</legend>

                    <div class="uk-margin uk-position-relative">
                        <label class="uk-form-label" for="street">Rue :</label>
                        <div class="uk-inline uk-width-1-1">
                            <span class="uk-form-icon" uk-icon="icon: location"></span>
                            <input class="uk-input" type="text" id="street" th:field="*{item.street}" placeholder="Ex : 10 rue Victor Hugo" autocomplete="off" required>
                        </div>
                        <ul id="autocomplete-results"></ul>
                    </div>

                    <div class="uk-grid uk-child-width-1-2@s" uk-grid>
                        <div>
                            <label class="uk-form-label" for="postalCode">Code postal</label>
                            <input class="uk-input" type="text" id="postalCode" th:field="*{item.postalCode}" required>
                        </div>
                        <div>
                            <label class="uk-form-label" for="city">Ville</label>
                            <input class="uk-input" type="text" id="city" th:field="*{item.city}" required>
                        </div>
                    </div>
                </fieldset>

                <!-- Boutons -->
                <div class="uk-margin-large-top uk-text-center">
                    <button class="uk-button uk-button-primary uk-button-large" type="submit">
                        <span uk-icon="icon: check"></span> Mettre √† jour
                    </button>
                    <button class="uk-button uk-button-default uk-button-large" type="reset">
                        <span uk-icon="icon: close"></span> R√©initialiser
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function previewImage(event) {
        const reader = new FileReader();
        const preview = document.getElementById('imagePreview');
        reader.onload = function () {
            preview.src = reader.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    const streetInput = document.getElementById('street');
    const postalInput = document.getElementById('postalCode');
    const cityInput = document.getElementById('city');
    const suggestionsBox = document.getElementById('autocomplete-results');

    streetInput.addEventListener('input', function () {
        const query = streetInput.value.trim();
        if (query.length < 3) {
            suggestionsBox.style.display = 'none';
            return;
        }

        fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`)
            .then(response => response.json())
            .then(data => {
                suggestionsBox.innerHTML = '';
                if (data.features.length === 0) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                data.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.className = 'uk-dropdown-item';
                    li.textContent = feature.properties.label;
                    li.onclick = () => {
                        streetInput.value = feature.properties.name;
                        postalInput.value = feature.properties.postcode;
                        cityInput.value = feature.properties.city;
                        suggestionsBox.style.display = 'none';
                    };
                    suggestionsBox.appendChild(li);
                });

                suggestionsBox.style.display = 'block';
            });
    });

    document.addEventListener('click', function (e) {
        if (!suggestionsBox.contains(e.target) && e.target !== streetInput) {
            suggestionsBox.style.display = 'none';
        }
    });
</script>

</body>
</html>