<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head th:replace="~{fragments/head :: uikit-head('home')}"></head>
<body>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<!-- Section de filtres -->
<div class="uk-section uk-section-small">
    <div class="uk-container">
        <h2>Filtres :</h2>
        <div class="uk-grid-small" uk-grid>
            <div class="uk-width-1-4@m">
                <label for="categories">Catégories:</label>
                <select class="uk-select" id="categories" name="categories">
                    <option value="0">Toutes</option>
                    <!-- On affiche dynamiquement toutes les catégories -->
                    <option th:each="category : ${categories}"
                            th:value="${category.categoryId}"
                            th:text="${category.label}">Catégorie</option>
                </select>
            </div>
            <div class="uk-width-1-2@m">
                <label for="search">Le nom de l'article contient:</label>
                <input class="uk-input" type="text" id="search" name="search">
            </div>
            <div class="uk-width-1-4@m uk-flex uk-flex-bottom">
                <button class="uk-button uk-button-primary" id="search-button" type="button">Rechercher</button>
            </div>
        </div>
    </div>
</div>



<!-- Liste des enchères -->
<div class="uk-section">
    <div class="uk-container">
        <!-- Message si aucune enchère -->
        <div id="no-bids-message" th:if="${#lists.isEmpty(bids)}" class="uk-alert uk-alert-warning">
            <p>Aucune enchère disponible pour le moment.</p>
        </div>

        <!-- Affichage des enchères -->
        <div id="bids-container" class="uk-grid uk-child-width-1-2@s uk-child-width-1-3@m" uk-grid>
            <div th:each="bid : ${bids}" class="uk-card uk-card-default uk-margin-bottom">
                <div class="uk-card-media-top">
                    <div class="uk-height-medium uk-background-muted uk-flex uk-flex-center uk-flex-middle">
                        <span>Pas d'image disponible</span>
                    </div>
                </div>
                <div class="uk-card-body">
                    <h3 class="uk-card-title" th:text="${bid.item.itemName}">Titre de l'article</h3>
                    <p><strong>Prix:</strong> <span th:text="${bid.bidAmount + ' €'}">0.00 €</span></p>
                    <p><strong>Fin de l'enchère:</strong> <span th:text="${bid.item.endDate}">01/01/2023</span></p>
                    <p><strong>Retrait:</strong> <span th:text="${bid.item.pickupLocationBid != null ?
                        (bid.item.pickupLocationBid.street + ', ' +
                         bid.item.pickupLocationBid.postalCode + ' ' +
                         bid.item.pickupLocationBid.city) : 'Non spécifié'}">Adresse</span></p>
                    <p><strong>Vendeur:</strong> <span th:text="${bid.item.seller != null ? bid.item.seller.username : 'Inconnu'}">Nom du vendeur</span></p>
                    <a th:href="@{'/bidding-page?id=' + ${bid.item.itemId}}" class="uk-button uk-button-primary uk-width-1-1">Voir détails</a>
                </div>
            </div>
        </div>
    </div>
</div>
<div sec:authorize="isAuthenticated()" class="uk-grid-small" uk-grid>
    <div class="uk-width-1-4@m">
        <label for="categories-auth">Catégories:</label>
        <select class="uk-select" id="categories-auth" name="categories">
            <option value="0">Toutes</option>
            <option th:each="category : ${categories}"
                    th:value="${category.categoryId}"
                    th:text="${category.label}">Catégorie</option>
        </select>
    </div>
    <div class="uk-width-1-4@m">
        <label for="search-auth">Le nom de l'article contient:</label>
        <input class="uk-input" type="text" id="search-auth" name="search">
    </div>
    <div class="uk-width-1-4@m">
        <label for="filter-type">Mes enchères:</label>
        <select class="uk-select" id="filter-type" name="filter-type">
            <option value="all">Toutes</option>
            <option value="my-bids">Mes enchères en cours</option>
            <option value="my-wins">Mes enchères remportées</option>
        </select>
    </div>
    <div class="uk-width-1-4@m uk-flex uk-flex-bottom">
        <button class="uk-button uk-button-primary" id="search-button-auth" type="button">Rechercher</button>
    </div>
</div>

<!-- Script AJAX pour le filtrage -->
<script>
    function updateBidsDisplay(bids) {
        const container = document.getElementById('bids-container');
        const noResultsMessage = document.getElementById('no-bids-message');

        // Vider le conteneur d'enchères
        container.innerHTML = '';

        if (!bids || bids.length === 0) {
            // Afficher un message si aucune enchère n'est disponible
            if (!noResultsMessage) {
                const messageDiv = document.createElement('div');
                messageDiv.id = 'no-bids-message';
                messageDiv.className = 'uk-alert uk-alert-warning';
                messageDiv.innerHTML = '<p>Aucune enchère disponible pour le moment.</p>';
                container.parentNode.insertBefore(messageDiv, container);
            } else {
                noResultsMessage.style.display = 'block';
            }
            return;
        }

        // Masquer le message "aucune enchère" s'il existe
        if (noResultsMessage) {
            noResultsMessage.style.display = 'none';
        }

        // Créer les cartes d'enchères
        bids.forEach(bid => {
            const bidCard = document.createElement('div');
            bidCard.className = 'uk-card uk-card-default uk-margin-bottom';

            // Vérifier que l'objet item existe
            const item = bid.item;
            if (!item) {
                console.error("L'objet 'item' est manquant pour cette enchère :", bid);
                return;
            }

            // Déterminer l'adresse de retrait
            let pickupAddress = 'Non spécifié';
            if (item.pickupLocationBid) {
                pickupAddress = `${item.pickupLocationBid.street}, ${item.pickupLocationBid.postalCode} ${item.pickupLocationBid.city}`;
            }

            // Construire le contenu de la carte
            bidCard.innerHTML = `
            <div class="uk-card-media-top">
                <div class="uk-height-medium uk-background-muted uk-flex uk-flex-center uk-flex-middle">
                    <span>Pas d'image disponible</span>
                </div>
            </div>
            <div class="uk-card-body">
                <h3 class="uk-card-title">${item.itemName || 'Nom non disponible'}</h3>
                <p><strong>Prix:</strong> <span>${bid.bidAmount} €</span></p>
                <p><strong>Fin de l'enchère:</strong> <span>${item.endDate || 'Non spécifié'}</span></p>
                <p><strong>Retrait:</strong> <span>${pickupAddress}</span></p>
                <p><strong>Vendeur:</strong> <span>${item.seller ? item.seller.username : 'Inconnu'}</span></p>
                <a href="/bidding-page?id=${item.itemId}" class="uk-button uk-button-primary uk-width-1-1">Voir détails</a>
            </div>
        `;

            container.appendChild(bidCard);
        });
    }

    // Fonction de filtrage des enchères
    function filterBids() {
        const categoryId = document.getElementById('categories').value;
        const searchText = document.getElementById('search').value.trim();

        let url = `/api/bids/filter?`;

        // Ajout du paramètre de catégorie si sélectionné
        if (categoryId && categoryId !== '0') {
            url += `categoryId=${categoryId}`;
        }

        // Ajout du paramètre de recherche si saisi
        if (searchText) {
            // Ajouter un & si le paramètre précédent existe
            if (categoryId && categoryId !== '0') {
                url += '&';
            }
            url += `search=${encodeURIComponent(searchText)}`;
        }

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau');
                }
                return response.json();
            })
            .then(data => {
                console.log("Données reçues :", data);
                updateBidsDisplay(data);
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
    }

    function filterBidsAuth() {
        const categoryId = document.getElementById('categories-auth').value;
        const searchText = document.getElementById('search-auth').value.trim();
        const filterType = document.getElementById('filter-type').value;

        let url = `/api/bids/filter?`;

        // Ajout du paramètre de catégorie si sélectionné
        if (categoryId && categoryId !== '0') {
            url += `categoryId=${categoryId}`;
        }

        // Ajout du paramètre de recherche si saisi
        if (searchText) {
            if (url.endsWith('?')) {
                url += `search=${encodeURIComponent(searchText)}`;
            } else {
                url += `&search=${encodeURIComponent(searchText)}`;
            }
        }

        // Ajout du type de filtre pour les enchères de l'utilisateur
        if (filterType && filterType !== 'all') {
            if (url.endsWith('?')) {
                url += `filterType=${filterType}`;
            } else {
                url += `&filterType=${filterType}`;
            }
        }

        fetch(url)
            .then(response => response.json())
            .then(data => updateBidsDisplay(data))
            .catch(error => console.error('Erreur:', error));
    }

    // Initialisation des gestionnaires d'événements
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion des filtres pour utilisateurs non connectés
        const categorySelect = document.getElementById('categories');
        const searchButton = document.getElementById('search-button');

        if (categorySelect) {
            categorySelect.addEventListener('change', filterBids);
        }

        if (searchButton) {
            searchButton.addEventListener('click', filterBids);
        }

        // Gestion des filtres pour utilisateurs connectés
        const categorySelectAuth = document.getElementById('categories-auth');
        const searchButtonAuth = document.getElementById('search-button-auth');
        const filterType = document.getElementById('filter-type');

        if (categorySelectAuth) {
            categorySelectAuth.addEventListener('change', filterBidsAuth);
        }

        if (searchButtonAuth) {
            searchButtonAuth.addEventListener('click', filterBidsAuth);
        }

        if (filterType) {
            filterType.addEventListener('change', filterBidsAuth);
        }
    });

</script>

</body>
</html>